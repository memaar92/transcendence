<!DOCTYPE html>
<html>
<head>
    <title>Pong Game</title>
    <style>
        #gameCanvas {
            background-color: #000;
            display: none; /* Hide the canvas by default */
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="800"></canvas>
    <button id="join-queue-button">Join Queue</button>
    <button id="reconnectButton" style="display: none;">Reconnect</button>
    <button id="connectToMatchButton" style="display: none;">Connect to Match</button>
</body>
    <script>
        window.onload = function() {

            let retryCount = 0;
            const maxRetries = 5;
            const retryDelay = 2000; // Milliseconds
            let match_id = null;
            let isActiveTab = false;

            const matchmakingSocket = new WebSocket('ws://' + window.location.host + '/ws/pong/matchmaking/');

            document.addEventListener("visibilitychange", function() {
                if (document.visibilityState === "visible") {
                    isActiveTab = true;
                    // Notify the server that this tab is now active
                    notifyTabActive();
                } else {
                    isActiveTab = false;
                }
            });

            function notifyTabActive() {
                matchmakingSocket.send(JSON.stringify({
                    "active": isActiveTab
                }))
            }
            
            matchmakingSocket.onopen = function(e) {
                console.log('Matchmaking WebSocket connection established.');
            };
    
            matchmakingSocket.onclose = function(e) {
                console.error('Matchmaking WebSocket connection closed.');
            };
    
            matchmakingSocket.onerror = function(e) {
                console.error('Matchmaking WebSocket error:', e);
            };
    
            matchmakingSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Received matchmaking message:', data);
                if (data.type === "match_assigned") {
                    if (data.match_id) {
                        console.log('Match found! Match ID: ' + data.match_id);
                        match_id = data.match_id;
                        // register_to_match(match_id);
                        connectToMatch(match_id);
                    }
                } else if (data.type === "match_in_progress") {
                    console.log('Match in progress.');
                    showReconnectButton(data.match_id); // Pass the correct match_id
                } else if (data.type === "registered") {
                    console.log('Registered to match.');
                    connectToMatch(match_id);
                } else if (data.type === "registration_timeout") {
                    console.log('Registration timeout.');
                } else if (data.type === "registration_error") {
                    console.error('Registration error:', data.error);
                }
            }

            function register_to_match() {
                console.log('Registering to match...');
                matchmakingSocket.send(JSON.stringify({
                    "request": "register",
                    "match_id": match_id
                }))
            }
    
            function joinQueue() {
                console.log('Joining queue...');
                matchmakingSocket.send(JSON.stringify({
                    "type": "matchmaking",
                    "request": "match",
                    "match_type": "online",
                }))
            }

            window.register_to_match = function(match_id) {
                console.log('Registering to match...');
                matchmakingSocket.send(JSON.stringify({
                    "request": "register",
                    "match_id": match_id
                }))
            }
    
            window.connectToMatch = function(match_id) {
                const matchSocket = new WebSocket('ws://' + window.location.host + '/ws/pong/match/' + match_id + '/');
                matchSocket.onopen = function(e) {
                    console.log('Match WebSocket connection established.');
                    const canvas = document.getElementById('gameCanvas');
                    canvas.style.display = 'block'; // Show the canvas
                    hideReconnectButton();
                };
    
                matchSocket.onclose = function(e) {
                    console.error('Match WebSocket connection closed.');
                };
    
                matchSocket.onerror = function(e) {
                    console.error('Match WebSocket error:', e);
                };
    
                matchSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    console.log('Received match message:', data);
                }
            }

            function showConnectToMatchButton(match_id) {
                const connectToMatchButton = document.getElementById('connectToMatchButton');
                if (connectToMatchButton) {
                    connectToMatchButton.style.display = 'block';
                    connectToMatchButton.onclick = function() {
                        connectToMatch(match_id);
                    };
                }
            }

            function hideConnectToMatchButton() {
                const connectToMatchButton = document.getElementById('connectToMatchButton');
                if (connectToMatchButton) {
                    connectToMatchButton.style.display = 'none';
                }
            }
            
            // Function to show the button
            function showReconnectButton(match_id) {
                const reconnectButton = document.getElementById('reconnectButton');
                if (reconnectButton) {
                    reconnectButton.style.display = 'block';
                    reconnectButton.onclick = function() {
                        connectToMatch(match_id);
                    };
                }
            }

            function hideReconnectButton() {
                const reconnectButton = document.getElementById('reconnectButton');
                if (reconnectButton) {
                    reconnectButton.style.display = 'none';
                }
            }

            document.getElementById('join-queue-button').onclick = joinQueue;
        }
    </script>
</html>

